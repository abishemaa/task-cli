import json
import os
import sys

TASKS_FILE = "tasks.json"

def load_tasks():
    """Load tasks from JSON file, create if doesn't exist"""
    try:
        if not os.path.exists(TASKS_FILE):
            return {"tasks": [], "next_id": 1}
        with open(TASKS_FILE, "r") as f:
            data = json.load(f)
            # Validate structure
            if not isinstance(data, dict) or "tasks" not in data:
                print(f"Error: Invalid JSON structure in {TASKS_FILE}")
                sys.exit(1)
            return data
    except json.JSONDecodeError:
        print(f"Error: Invalid JSON in {TASKS_FILE}")
        sys.exit(1)
    except IOError as e:
        print(f"Error reading {TASKS_FILE}: {str(e)}")
        sys.exit(1)

def save_tasks(data):
    """Save tasks to JSON file with error handling"""
    try:
        with open(TASKS_FILE, "w") as f:
            json.dump(data, f, indent=2)
    except IOError as e:
        print(f"Error writing to {TASKS_FILE}: {str(e)}")
        raise

def main():
    """Main entry point - processes command-line arguments"""
    if len(sys.argv) < 2:
        print("Task-cli - Command line task manager")
        print("Usage: python index.py <command> [arguments]")
        print("Type 'python index.py help' for available commands")
        sys.exit(1)
    
    command = sys.argv[1]
    arguments = sys.argv[2:]
    
    cli_handle_command(command, arguments)

def cli_handle_command(command, args):
    """Route command to appropriate handler"""
    case = {
        "help": help,
        "exit": exit,
        "add": add,
        "list": list,
        "remove": remove,
        "update": update,
        "mark": mark,
        "done": mark_done,
        "in-progress": mark_in_progress,
        "not-done": mark_not_done,
    }
    
    handler = case.get(command, cli_invalid_command)
    try:
        handler(args)
    except Exception as e:
        print(f"Error: {str(e)}")
        sys.exit(1)

def help(args):
    """Display help information"""
    print("Task-cli - Command line task manager")
    print("\nUsage: python index.py <command> [arguments]\n")
    print("Commands:")
    print("  help                              Show this help message")
    print("  add <task>                        Add a new task")
    print("  list [filter]                     List tasks (filter: all, done, not-done, in-progress)")
    print("  update <task_id> <description>   Update task description")
    print("  mark <task_id> <status>          Mark task with status")
    print("  done <task_id>                    Mark task as done")
    print("  in-progress <task_id>            Mark task as in progress")
    print("  not-done <task_id>               Mark task as not done")
    print("  remove <task_id>                 Remove a task")
    print("  exit                              Exit the application")
    print("\nExamples:")
    print("  python index.py add buy groceries")
    print("  python index.py list")
    print("  python index.py list done")
    print("  python index.py mark 1 done")
    print("  python index.py done 1")
    print("  python index.py update 1 buy milk and bread")
    print("  python index.py remove 1")

def exit(args):
    """Exit the application"""
    print("Exiting Task-cli...")
    sys.exit(0)

def add(args):
    """Add a new task"""
    if not args:
        print("Error: Please provide a task name.")
        print("Usage: python index.py add <task_description>")
        sys.exit(1)
    
    task = " ".join(args)
    try:
        data = load_tasks()
        new_task = {"id": data["next_id"], "task": task, "status": "not-done"}
        data["tasks"].append(new_task)
        data["next_id"] += 1
        save_tasks(data)
        print(f"✓ Added task: {task} (ID: {new_task['id']})")
    except Exception as e:
        print(f"Error adding task: {str(e)}")
        sys.exit(1)

def list(args):
    """List tasks, optionally filtered by status"""
    try:
        data = load_tasks()
        if not data["tasks"]:
            print("No tasks found.")
            return
        
        # Determine filter
        filter_status = args[0].lower() if args else None
        valid_filters = ["done", "not-done", "in-progress", "all", None]
        
        if filter_status and filter_status not in valid_filters:
            print(f"Error: Invalid filter '{filter_status}'")
            print("Valid filters: all, done, not-done, in-progress")
            sys.exit(1)
        
        # Filter tasks
        filtered_tasks = data["tasks"]
        if filter_status and filter_status != "all":
            filtered_tasks = [t for t in data["tasks"] if t.get("status") == filter_status]
        
        if not filtered_tasks:
            print(f"No tasks found with status: {filter_status if filter_status else 'any'}")
            return
        
        display_label = f" ({filter_status})" if filter_status and filter_status != "all" else ""
        print(f"\nTasks{display_label}:")
        for task in filtered_tasks:
            status = task.get("status", "not-done")
            print(f"  ID {task['id']} [{status}]: {task['task']}")
        print()
    except Exception as e:
        print(f"Error listing tasks: {str(e)}")
        sys.exit(1)

def update(args):
    """Update a task's description"""
    if len(args) < 2:
        print("Error: Missing arguments")
        print("Usage: python index.py update <task_id> <new_description>")
        sys.exit(1)
    
    try:
        task_id = int(args[0])
    except ValueError:
        print(f"Error: Task ID must be a number, got '{args[0]}'")
        sys.exit(1)
    
    new_description = " ".join(args[1:])
    
    try:
        data = load_tasks()
        task_found = False
        
        for task in data["tasks"]:
            if task["id"] == task_id:
                old_description = task["task"]
                task["task"] = new_description
                save_tasks(data)
                print(f"✓ Updated task {task_id}: '{old_description}' -> '{new_description}'")
                task_found = True
                break
        
        if not task_found:
            print(f"Error: Task with ID {task_id} not found.")
            sys.exit(1)
    except Exception as e:
        print(f"Error updating task: {str(e)}")
        sys.exit(1)

def mark(args):
    """Mark a task with a specific status"""
    if len(args) < 2:
        print("Error: Missing arguments")
        print("Usage: python index.py mark <task_id> <status>")
        print("Valid statuses: done, in-progress, not-done")
        sys.exit(1)
    
    try:
        task_id = int(args[0])
    except ValueError:
        print(f"Error: Task ID must be a number, got '{args[0]}'")
        sys.exit(1)
    
    status = args[1].lower()
    valid_statuses = ["done", "in-progress", "not-done"]
    
    if status not in valid_statuses:
        print(f"Error: Invalid status '{status}'")
        print(f"Valid statuses: {', '.join(valid_statuses)}")
        sys.exit(1)
    
    try:
        data = load_tasks()
        task_found = False
        
        for task in data["tasks"]:
            if task["id"] == task_id:
                old_status = task.get("status", "not-done")
                task["status"] = status
                save_tasks(data)
                print(f"✓ Task {task_id} marked as {status} (was: {old_status})")
                task_found = True
                break
        
        if not task_found:
            print(f"Error: Task with ID {task_id} not found.")
            sys.exit(1)
    except Exception as e:
        print(f"Error marking task: {str(e)}")
        sys.exit(1)

def mark_done(args):
    """Shorthand for marking task as done"""
    if not args:
        print("Error: Missing task ID")
        print("Usage: python index.py done <task_id>")
        sys.exit(1)
    mark([args[0], "done"])

def mark_in_progress(args):
    """Shorthand for marking task as in-progress"""
    if not args:
        print("Error: Missing task ID")
        print("Usage: python index.py in-progress <task_id>")
        sys.exit(1)
    mark([args[0], "in-progress"])

def mark_not_done(args):
    """Shorthand for marking task as not-done"""
    if not args:
        print("Error: Missing task ID")
        print("Usage: python index.py not-done <task_id>")
        sys.exit(1)
    mark([args[0], "not-done"])

def remove(args):
    """Remove a task by ID"""
    if not args:
        print("Error: Missing task ID")
        print("Usage: python index.py remove <task_id>")
        sys.exit(1)
    
    try:
        task_id = int(args[0])
    except ValueError:
        print(f"Error: Task ID must be a number, got '{args[0]}'")
        sys.exit(1)
    
    try:
        data = load_tasks()
        original_count = len(data["tasks"])
        data["tasks"] = [t for t in data["tasks"] if t["id"] != task_id]
        
        if len(data["tasks"]) < original_count:
            save_tasks(data)
            print(f"✓ Removed task with ID: {task_id}")
        else:
            print(f"Error: Task with ID {task_id} not found.")
            sys.exit(1)
    except Exception as e:
        print(f"Error removing task: {str(e)}")
        sys.exit(1)

def cli_invalid_command(args):
    """Handle invalid commands"""
    print(f"Error: Invalid command")
    print("Type 'python index.py help' for available commands")
    sys.exit(1)


if __name__ == "__main__":
    main()
